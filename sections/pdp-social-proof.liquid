{% comment %} PDP Social Proof - v3.6 (edge-centered static arrows + multiline clamp) {% endcomment %}
<section id="sp-{{ section.id }}" class="sp-wrap color-{{ section.settings.color_scheme }}">
  <div class="sp-inner page-width">
    {% if section.settings.heading != blank %}
      <h2 class="sp-heading">{{ section.settings.heading }}</h2>
    {% endif %}

    <div class="sp-rail">
      <div class="sp-scroller" id="sp-scroller-{{ section.id }}" aria-label="Customer reviews">
        {% for block in section.blocks %}
          {% if block.type == 'review' %}
          <article class="sp-card" {{ block.shopify_attributes }}>
            <div class="sp-media">
              {% if block.settings.photo %}
                {% assign sp_alt = block.settings.name | default: 'Review photo' | strip | escape %}
                {{ block.settings.photo
                  | image_url: width: 1400
                  | image_tag: alt: sp_alt, class: 'sp-img', loading: 'lazy', widths: '600,900,1200,1400', sizes: '100vw' }}
              {% else %}
                <div class="sp-img placeholder"></div>
              {% endif %}
            </div>

            <div class="sp-body">
              <div class="sp-row">
                <div class="sp-stars" aria-label="{{ block.settings.rating }} out of 5 stars">
                  {% assign r = block.settings.rating | default: 5 %}
                  {% for i in (1..r) %}
                    <svg class="sp-star" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path d="M12 2l3.09 6.26L22 9.27l-5 4.86L18.18 22 12 18.6 5.82 22 7 14.13l-5-4.86 6.91-1.01L12 2z"/></svg>
                  {% endfor %}
                </div>
                {% if block.settings.timestamp != blank %}
                  <div class="sp-meta">{{ block.settings.timestamp }}</div>
                {% endif %}
              </div>

              {% if block.settings.content != blank %}
                <p class="sp-text">{{ block.settings.content }}</p>
              {% endif %}

              <div class="sp-footer">
                <div class="sp-name">{{ block.settings.name }}</div>
                {% if block.settings.verified %}
                <div class="sp-verified">
                  <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path d="M9 16.2l-3.5-3.5 1.4-1.4L9 13.4l7.1-7.1 1.4 1.4z"/></svg>
                  <span>Verified buyer</span>
                </div>
                {% endif %}
              </div>
            </div>
          </article>
          {% endif %}
        {% endfor %}
      </div>

      {% if section.settings.show_arrows %}
        <button class="sp-btn sp-prev" type="button" id="sp-prev-{{ section.id }}" aria-label="Previous">
          <svg viewBox="0 0 24 24" width="20" height="20"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z" fill="currentColor"/></svg>
        </button>
        <button class="sp-btn sp-next" type="button" id="sp-next-{{ section.id }}" aria-label="Next">
          <svg viewBox="0 0 24 24" width="20" height="20"><path d="M8.59 16.59 10 18l6-6-6-6-1.41 1.41L12.17 12z" fill="currentColor"/></svg>
        </button>
      {% endif %}
    </div>
  </div>

  <style>
    #sp-{{ section.id }}{padding:24px 0}
    #sp-{{ section.id }} .sp-heading{
      text-align:center; font-size:clamp(18px,3vw,30px); font-weight:700;
      margin:0 0 {{ section.settings.heading_space | default: 16 }}px;
    }

    /* 轨道：JS 控制步进与吸附；允许按钮“溢出一半” */
    #sp-{{ section.id }} .sp-rail{ position:relative; overflow:visible; }
    #sp-{{ section.id }} .sp-scroller{
      --gap:16px; display:flex; gap:var(--gap); overflow:auto; padding:8px 4px;
      scroll-behavior:smooth; scrollbar-width:none; -ms-overflow-style:none; -webkit-overflow-scrolling:touch;
    }
    #sp-{{ section.id }} .sp-scroller::-webkit-scrollbar{width:0;height:0}

    /* 手机：单卡；桌面：4 列 */
    #sp-{{ section.id }} .sp-card{
      flex:0 0 100%;
      background:var(--color-background,#fff);
      border:1px solid rgba(0,0,0,.08); border-radius:16px; overflow:hidden;
      box-shadow:0 2px 10px rgba(0,0,0,.06);
      transition:transform .2s ease, box-shadow .2s ease;
    }
    #sp-{{ section.id }} .sp-card:hover{transform:translateY(-2px); box-shadow:0 10px 24px rgba(0,0,0,.08)}
    @media (min-width:990px){
      #sp-{{ section.id }} .sp-card{ flex:0 0 calc((100% - 3*var(--gap))/4) }
    }

    /* 媒体：更高（4:5） */
    #sp-{{ section.id }} .sp-media{aspect-ratio:4/5; background:rgba(0,0,0,.03)}
    #sp-{{ section.id }} .sp-img{width:100%;height:100%;object-fit:cover;display:block}

    /* 文案（多行省略截断） */
    #sp-{{ section.id }} .sp-body{padding:12px 14px}
    #sp-{{ section.id }} .sp-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    #sp-{{ section.id }} .sp-stars{display:flex;gap:2px}
    #sp-{{ section.id }} .sp-star{fill:#f59e0b}
    #sp-{{ section.id }} .sp-meta{font-size:13px;color:rgba(0,0,0,.6)}

    #sp-{{ section.id }} .sp-text{
      margin:6px 0 12px; line-height:1.5; overflow:hidden;
      display:-webkit-box; -webkit-box-orient:vertical; -webkit-line-clamp:4;   /* 手机 4 行 */
      max-height:calc(1.5em * 4); text-overflow:ellipsis;
    }
    @media (min-width:990px){
      #sp-{{ section.id }} .sp-text{
        -webkit-line-clamp:3; max-height:calc(1.5em * 3);                     /* 桌面 3 行 */
      }
    }

    #sp-{{ section.id }} .sp-footer{display:flex;align-items:center;justify-content:space-between}
    #sp-{{ section.id }} .sp-name{font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    #sp-{{ section.id }} .sp-verified{display:flex;align-items:center;gap:6px;font-size:12px;color:rgba(0,0,0,.8)}
    #sp-{{ section.id }} .sp-verified svg{fill:#10b981}

    /* 按钮固定：中心压在左右边框线（半内半外），--tweak 可微调 */
    #sp-{{ section.id }} .sp-btn{
      --tweak: 0px;                  /* 往里收：正值；往外推：负值（例如 2px/-2px） */
      position:absolute; top:50%;
      width:44px; height:44px; border:1px solid rgba(0,0,0,.12);
      background:#fff; border-radius:999px; display:grid; place-items:center; color:#2f2f2f;
      box-shadow:0 6px 18px rgba(0,0,0,.14); z-index:5; pointer-events:auto;
    }
    #sp-{{ section.id }} .sp-prev{ left:0;  transform:translate(calc(-50% + var(--tweak)), -50%); }
    #sp-{{ section.id }} .sp-next{ right:0; transform:translate(calc( 50% - var(--tweak)), -50%); }
    #sp-{{ section.id }} .sp-btn.is-off{opacity:.35;pointer-events:none}
  </style>

  <script>
  (function(){
    const scroller = document.getElementById('sp-scroller-{{ section.id }}');
    if(!scroller) return;
    const prev = document.getElementById('sp-prev-{{ section.id }}');
    const next = document.getElementById('sp-next-{{ section.id }}');
    const cards = Array.from(scroller.querySelectorAll('.sp-card'));

    const cols = () => (window.innerWidth >= 990 ? 4 : 1);

    /* 精准步长：用 offsetLeft 差值，避免像素误差引发晃动 */
    function stepPx(){
      if(cards.length < 2) {
        return scroller.querySelector('.sp-card')?.getBoundingClientRect().width || scroller.clientWidth;
      }
      return Math.round(cards[1].offsetLeft - cards[0].offsetLeft);
    }
    function maxIndex(){ return Math.max(0, cards.length - cols()); }
    function currentIndex(){
      const s = stepPx(); if(!s) return 0;
      return Math.min(maxIndex(), Math.max(0, Math.round(scroller.scrollLeft / s)));
    }
    function scrollToIndex(i, smooth=true){
      i = Math.min(maxIndex(), Math.max(0, i));
      const left = Math.round(i * stepPx());
      scroller.scrollTo({ left, behavior: smooth ? 'smooth' : 'auto' });
      requestAnimationFrame(syncArrows);
      setTimeout(syncArrows, 260);
    }
    function syncArrows(){
      if(!prev || !next) return;
      const i = currentIndex();
      prev.classList.toggle('is-off', i <= 0);
      next.classList.toggle('is-off', i >= maxIndex());
    }
    function go(dir){ scrollToIndex(currentIndex() + dir); }

    /* 交互 */
    prev && prev.addEventListener('click', e=>{ e.preventDefault(); e.stopPropagation(); go(-1); });
    next && next.addEventListener('click', e=>{ e.preventDefault(); e.stopPropagation(); go(1); });

    // 点击卡片 → 回到产品顶部
    scroller.addEventListener('click', (e)=>{
      if(e.target.closest('.sp-btn')) return;
      const card = e.target.closest('.sp-card'); if(!card) return;
      e.preventDefault();
      const anchor = document.getElementById('MainContent') || document.querySelector('main');
      const top = anchor ? (anchor.getBoundingClientRect().top + window.pageYOffset) : 0;
      window.scrollTo({ top, behavior:'smooth' });
    });

    // 手势滚动：停止后吸附到最近整卡（按钮位置不变）
    let snapTimer = null;
    scroller.addEventListener('scroll', ()=>{
      clearTimeout(snapTimer);
      snapTimer = setTimeout(()=> scrollToIndex(currentIndex()), 100);
    }, {passive:true});

    // 视口变化：保持索引
    let resizeTimer=null;
    window.addEventListener('resize', ()=>{
      clearTimeout(resizeTimer);
      const keep = currentIndex();
      resizeTimer = setTimeout(()=>{ scrollToIndex(keep, false); }, 120);
    });

    // 初始化
    requestAnimationFrame(()=>{ scrollToIndex(0, false); });
  })();
  </script>
</section>

{% schema %}
{
  "name": "晒单评价滑块",
  "settings": [
    { "type": "text", "id": "heading", "label": "标题", "default": "Don't just take our word for it." },
    { "type": "range", "id": "heading_space", "label": "标题下边距(px)", "min": 4, "max": 40, "step": 2, "default": 16 },
    { "type": "color_scheme", "id": "color_scheme", "label": "配色方案", "default": "background-1" },
    { "type": "checkbox", "id": "show_arrows", "label": "显示左右箭头（移动端与桌面端）", "default": true }
  ],
  "blocks": [
    {
      "type": "review",
      "name": "评价卡片",
      "settings": [
        { "type": "image_picker", "id": "photo", "label": "配图" },
        { "type": "range", "id": "rating", "label": "星级", "min": 1, "max": 5, "step": 1, "default": 5 },
        { "type": "text", "id": "timestamp", "label": "时间（如 7 days ago）", "default": "7 days ago" },
        { "type": "textarea", "id": "content", "label": "文案/评价内容", "default": "This mower is the best purchase I've made!" },
        { "type": "text", "id": "name", "label": "买家昵称", "default": "Cliff R." },
        { "type": "checkbox", "id": "verified", "label": "显示 Verified buyer", "default": true }
      ]
    }
  ],
  "max_blocks": 24,
  "presets": [{ "name": "晒单评价滑块（按钮切换，手机1/桌面4）", "category": "Product" }]
}
{% endschema %}
