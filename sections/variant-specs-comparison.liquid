{% comment %}
  Variant Specs Comparison Section
  Shows a comparison table of specifications across product variants
{% endcomment %}

{%- liquid
  # Determine which product to use
  if section.settings.product != blank
    assign target_product = section.settings.product
  elsif product != blank
    assign target_product = product
  else
    assign target_product = nil
  endif
-%}

{%- if target_product != blank and target_product.variants.size > 0 -%}
  <div class="variant-specs-comparison page-width section-{{ section.id }}-padding">
    <div class="comparison-wrapper">
      {%- if section.settings.heading != blank -%}
        <h2 class="comparison-heading">{{ section.settings.heading }}</h2>
      {%- endif -%}

      {%- if section.settings.show_toggle -%}
        <div class="comparison-controls">
          <label class="toggle-control">
            <input type="checkbox" id="only-differences-{{ section.id }}" class="only-differences-toggle">
            <span class="toggle-label">{{ section.settings.toggle_label | default: 'Only show differences' }}</span>
          </label>
        </div>
      {%- endif -%}

      <div
        class="specs-comparison-grid"
        style="--variant-count: {{ target_product.variants.size }};"
        data-section-id="{{ section.id }}"
      >
        {%- comment -%} Header Row {%- endcomment -%}
        <div class="spec-row spec-header" style="display: contents;">
          <div class="spec-label-header">
            <span>{{ section.settings.spec_label | default: 'Specifications' }}</span>
          </div>

          {%- for variant in target_product.variants -%}
            <div class="spec-variant-header">
              <div class="variant-image-wrapper">
                {%- if variant.image != blank -%}
                  <img
                    src="{{ variant.image | image_url: width: 200 }}"
                    alt="{{ variant.title }}"
                    loading="lazy"
                    width="200"
                    height="200"
                  >
                {%- elsif target_product.featured_image != blank -%}
                  <img
                    src="{{ target_product.featured_image | image_url: width: 200 }}"
                    alt="{{ variant.title }}"
                    loading="lazy"
                    width="200"
                    height="200"
                  >
                {%- endif -%}
              </div>
              <div class="variant-info">
                <h3 class="variant-title">{{ variant.title }}</h3>
                <p class="variant-price">{{ variant.price | money }}</p>
              </div>
            </div>
          {%- endfor -%}
        </div>

        {%- comment -%} Specification Rows {%- endcomment -%}
        {%- assign spec_keys = section.settings.spec_keys | split: ',' -%}
        {%- assign spec_labels = section.settings.spec_labels | split: ',' -%}

        {%- for spec_key in spec_keys -%}
          {%- assign key_trimmed = spec_key | strip -%}
          {%- assign spec_index = forloop.index0 -%}
          {%- assign spec_label = spec_labels[spec_index] | strip | default: key_trimmed -%}

          <div class="spec-row" style="display: contents;" data-spec-key="{{ key_trimmed }}">
            <div class="spec-label">
              {{ spec_label }}
            </div>

            {%- for variant in target_product.variants -%}
              {%- assign spec_value = variant.metafields.custom[key_trimmed] -%}
              <div class="spec-value" data-variant-id="{{ variant.id }}">
                {%- if spec_value != blank -%}
                  {{ spec_value }}
                {%- else -%}
                  <span class="spec-empty">â€”</span>
                {%- endif -%}
              </div>
            {%- endfor -%}
          </div>
        {%- endfor -%}
      </div>
    </div>
  </div>

  <style>
    .variant-specs-comparison {
      margin: 40px auto;
    }

    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }

    .comparison-wrapper {
      max-width: 100%;
      overflow-x: auto;
    }

    .comparison-heading {
      text-align: center;
      margin-bottom: 24px;
      font-size: 28px;
      font-weight: bold;
    }

    .comparison-controls {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 16px;
    }

    .toggle-control {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
    }

    .only-differences-toggle {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .toggle-label {
      font-size: 14px;
      font-weight: 500;
    }

    .specs-comparison-grid {
      display: grid;
      grid-template-columns: 200px repeat(var(--variant-count), 1fr);
      gap: 1px;
      background-color: #e5e5e5;
      border: 1px solid #e5e5e5;
      min-width: max-content;
    }

    .spec-row {
      display: contents;
    }

    .spec-row.hidden {
      display: none;
    }

    .spec-label-header,
    .spec-variant-header,
    .spec-label,
    .spec-value {
      background-color: white;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .spec-label-header {
      font-weight: 700;
      font-size: 16px;
      background-color: #f9fafb;
      border-right: 2px solid #e5e5e5;
    }

    .spec-variant-header {
      flex-direction: column;
      background-color: #f9fafb;
      font-weight: 600;
      gap: 12px;
    }

    .variant-image-wrapper {
      width: 100%;
      max-width: 150px;
      aspect-ratio: 1;
      overflow: hidden;
      border-radius: 8px;
    }

    .variant-image-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .variant-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .variant-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }

    .variant-price {
      font-size: 18px;
      font-weight: 700;
      color: #28A745;
      margin: 0;
    }

    .spec-label {
      font-weight: 600;
      background-color: #f9fafb;
      justify-content: center;
      border-right: 2px solid #e5e5e5;
    }

    .spec-value {
      font-size: 14px;
    }

    .spec-empty {
      color: #9ca3af;
    }

    /* Responsive Design */
    @media screen and (max-width: 768px) {
      .specs-comparison-grid {
        grid-template-columns: 150px repeat(var(--variant-count), minmax(150px, 1fr));
      }

      .comparison-heading {
        font-size: 24px;
      }

      .spec-label-header,
      .spec-variant-header,
      .spec-label,
      .spec-value {
        padding: 12px;
        font-size: 13px;
      }

      .variant-title {
        font-size: 14px;
      }

      .variant-price {
        font-size: 16px;
      }
    }
  </style>

  <script>
    (function() {
      const sectionId = '{{ section.id }}';
      const toggle = document.getElementById('only-differences-' + sectionId);
      const grid = document.querySelector('[data-section-id="' + sectionId + '"]');

      if (!toggle || !grid) return;

      toggle.addEventListener('change', function() {
        const specRows = grid.querySelectorAll('.spec-row:not(.spec-header)');

        specRows.forEach(function(row) {
          // Get all spec values in this row (excluding the label)
          const values = Array.from(row.querySelectorAll('.spec-value'));

          if (values.length === 0) return;

          // Extract text content from each value
          const textValues = values.map(function(cell) {
            return cell.textContent.trim();
          });

          // Check if all values are the same
          const allSame = textValues.every(function(val, i, arr) {
            return val === arr[0];
          });

          // Show/hide row based on toggle state and whether values differ
          if (toggle.checked && allSame) {
            row.classList.add('hidden');
          } else {
            row.classList.remove('hidden');
          }
        });
      });
    })();
  </script>
{%- else -%}
  <div class="page-width section-{{ section.id }}-padding">
    <div style="text-align: center; padding: 40px 20px; background-color: #f9fafb; border-radius: 8px;">
      <p style="color: #6b7280; font-size: 14px;">
        {%- if target_product == blank -%}
          Please select a product in the section settings or add this section to a product page.
        {%- else -%}
          This product has no variants to compare.
        {%- endif -%}
      </p>
    </div>
  </div>
{%- endif -%}

{% schema %}
{
  "name": "Variant Specs Comparison",
  "tag": "section",
  "class": "section-variant-specs-comparison",
  "settings": [
    {
      "type": "product",
      "id": "product",
      "label": "Product",
      "info": "Leave empty to use the current product page's product"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Compare Specifications"
    },
    {
      "type": "text",
      "id": "spec_label",
      "label": "Specifications Column Label",
      "default": "Specifications"
    },
    {
      "type": "textarea",
      "id": "spec_keys",
      "label": "Specification Keys",
      "info": "Comma-separated list of metafield keys (e.g., lawn_size, battery_capacity, engine, climbing_ability)",
      "default": "lawn_size, battery_capacity, engine, climbing_ability"
    },
    {
      "type": "textarea",
      "id": "spec_labels",
      "label": "Specification Labels",
      "info": "Comma-separated list of labels corresponding to the keys above (e.g., Lawn Size, Battery Capacity, Engine, Climbing Ability)",
      "default": "Lawn Size, Battery Capacity, Engine, Climbing Ability"
    },
    {
      "type": "checkbox",
      "id": "show_toggle",
      "label": "Show 'Only Differences' Toggle",
      "default": true
    },
    {
      "type": "text",
      "id": "toggle_label",
      "label": "Toggle Label",
      "default": "Only show differences"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding Top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding Bottom",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Variant Specs Comparison"
    }
  ]
}
{% endschema %}
